# Offline Loop Closure Documentation

## Overview
The `offline_loop_closure` executable performs offline loop closure detection, pose graph optimization, and bundle adjustment on LiDAR submaps. This tool is designed to refine a previously built submap-based map by detecting loop closures and optimizing the submap poses to reduce accumulated drift.

## Usage

```bash
offline_loop_closure -d <data_folder> [OPTIONS]
```

or

```bash
ros2 run ffastllamaa offline_loop_closure -d <data_folder> [OPTIONS]
```

## Command-Line Arguments

### Required Arguments

| Argument | Short | Description |
|----------|-------|-------------|
| `--data_folder` | `-d` | Path to the data folder containing submap data (must contain loop closure results from the Python preprocessing script) |

### Optional Arguments

| Argument | Type | Default | Description |
|----------|------|---------|-------------|
| `--odom_pos_std` | double | `0.2` | Standard deviation of odometry position measurements (meters) - used to weight odometry constraints in optimization |
| `--odom_rot_std` | double | `1.0` | Standard deviation of odometry rotation measurements (radians) - used to weight odometry constraints in optimization |
| `--loop_pos_std` | double | `0.2` | Standard deviation of loop closure position measurements (meters) - used to weight loop closure constraints in optimization |
| `--loop_rot_std` | double | `0.0175` | Standard deviation of loop closure rotation measurements (radians, default: 1° in radians) - used to weight loop closure constraints |
| `--loop_loss_scale_pos` | double | `1.0` | Robust loss function scale for loop closure position residuals (meters) - larger values allow more outliers |
| `--loop_loss_scale_rot` | double | `0.0175` | Robust loss function scale for loop closure rotation residuals (radians, default: 1° in radians) - larger values allow more outliers |
| `--ram_efficient` | flag | disabled | Enable RAM-efficient mode for bundle adjustment (significantly slower but uses less memory) |
| `--help` | `-h` | - | Print help message and exit |

## Input Data Requirements

The data folder must contain the following files (typically generated by the `loop_closure.py` preprocessing script):

| File | Description |
|------|-------------|
| `submap_poses.txt` | Initial submap poses (one pose per line: x, y, z, qw, qx, qy, qz) |
| `loop_closures.txt` | Detected loop closure pairs (one pair per line: submap_id_1, submap_id_2) |
| `loop_transforms.txt` | Relative transformations for each loop closure (4x4 transformation matrices) |
| `submap_*.ply` | Individual submap point clouds (referenced by submap IDs) |

## Output Files

The executable generates the following files in the data folder:

| File | Description |
|------|-------------|
| `optimized_poses.txt` | Optimized submap poses after pose graph optimization (format: x, y, z, qw, qx, qy, qz) |
| `optimized_map.ply` | Full map reconstructed with optimized submap poses (optional, if full map generation is enabled) |


## Example Usage

### Basic Usage
```bash
# Run with default parameters
offline_loop_closure -d /path/to/map_data
```

### Custom Weighting
```bash
# Trust loop closures more than odometry
offline_loop_closure -d /path/to/map_data \
  --odom_pos_std 0.5 \
  --odom_rot_std 2.0 \
  --loop_pos_std 0.1 \
  --loop_rot_std 0.01
```

### Robust to Outliers
```bash
# Increase loss function scale to be more tolerant of outlier loop closures
offline_loop_closure -d /path/to/map_data \
  --loop_loss_scale_pos 2.0 \
  --loop_loss_scale_rot 0.05
```

### RAM-Efficient Mode
```bash
# Use RAM-efficient mode for large maps (slower but uses less memory)
offline_loop_closure -d /path/to/map_data --ram_efficient
```
